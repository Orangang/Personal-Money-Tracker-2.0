<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è ‚Äî Dmitry Money Tracker</title>
<link rel="shortcut icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='42'>üîê</text></svg>">
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --ink:#111; --muted:#6b7280; --line:#e5e7eb;
  --accent:#2d6cdf; --accent-100:#eef3ff; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.06);
  --fs-base:clamp(14px,1.2vw,16px); --fs-sm:clamp(12px,1.1vw,14px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:400 var(--fs-base)/1.45 "SF Pro Display",-apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
}
a{color:var(--accent); text-decoration:none}
a:hover{text-decoration:underline}
.wrap{min-height:100vh; min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:20px;}
.card{width:min(480px,94vw); background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:22px 20px; margin:0 auto;}
h1{margin:0 0 12px; text-align:center; font-size:clamp(18px,2.4vw,22px); font-weight:700;}
label{font-size:var(--fs-sm); color:var(--muted); display:flex; flex-direction:column; gap:8px; margin-bottom:10px;}
input{width:100%; min-height:42px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font:inherit;}
button{border-radius:10px; border:1px solid #d4e1ff; background:#eaf1ff; color:#1f4fbf; font-weight:700; cursor:pointer; transition:border-color .2s,background .2s;}
button.primary{border-color:#2d6cdf; background:#2d6cdf; color:#fff;}
.actions{ margin-top:12px; }
.actions button{ width:100%; min-height:42px; padding:10px 12px; }
.form-hr{width:100%; height:1px; background:var(--line); margin:14px auto 0;}
.help{color:var(--muted); font-size:var(--fs-sm); text-align:center; margin-top:12px}
.alert{padding:10px 12px; border:1px solid #e5e7eb; background:#f9fafb; border-radius:10px; font-size:var(--fs-sm); color:#374151; margin-bottom:16px}
.alert.ok{border-color:#c6f1d3; background:#ecfdf5; color:#065f46}
.alert.err{border-color:#ffd6d6; background:#fff1f1; color:#991b1b}
.hidden{display:none!important}
footer{margin-top:14px; text-align:center; color:#6b7280; font-size:var(--fs-sm);}
@media (max-width:420px){ .card{padding:18px 16px} }
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h1>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h1>

    <div id="msg" class="alert hidden"></div>

    <!-- –†–ï–ñ–ò–ú 1: –µ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ URL, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è -->
    <form id="frmSet" class="hidden" autocomplete="on">
      <div class="alert">–ê–∫–∫–∞—É–Ω—Ç: <b id="who"></b></div>
      <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
        <input type="password" id="p1" minlength="6" required autocomplete="new-password" name="new-password">
      </label>
      <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å
        <input type="password" id="p2" minlength="6" required autocomplete="new-password" name="new-password-confirm">
      </label>
      <div class="actions">
        <button type="submit" class="primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </form>

    <!-- –†–ï–ñ–ò–ú 2: –ø—Ä–∏—à–ª–∏ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∏—Å—å–º–æ -->
    <form id="frmAsk" class="hidden" autocomplete="on">
      <div class="alert">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–±—Ä–æ—Å–∞. –û—Ç–ø—Ä–∞–≤–∏–º –ø–∏—Å—å–º–æ –µ—â—ë —Ä–∞–∑.</div>
      <label>Email
        <input type="email" id="ask-email" placeholder="you@example.com" required autocomplete="username">
      </label>
      <div class="actions">
        <button type="submit" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ</button>
      </div>
      <div class="form-hr"></div>
      <div class="help"><a href="auth.html">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É</a></div>
    </form>

    <footer>—Å–¥–µ–ª–∞–Ω–æ —Ä—É–∫–∞–º–∏ <a href="https://dmitry-design.ru/" target="_blank" rel="noopener">dmitry-design.ru</a></footer>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–∞ –∂–µ –ø–∞—Ä–∞, —á—Ç–æ –∏ –≤ auth.html) ===== */
const SUPABASE_URL = "https://hxbrvnwukieluzlffgyr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4YnJ2bnd1a2llbHV6bGZmZ3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NTM1NDMsImV4cCI6MjA3NzAyOTU0M30.IWViKSutxlXo1R3DqArijjeseK6nQ9m55ZPe5EUToLQ";
const INDEX_URL = "https://cdn-dmitry-design.github.io/Personal-Money-Tracker-2.0/index.html";
const RESET_URL = "https://cdn-dmitry-design.github.io/Personal-Money-Tracker-2.0/reset.html"; // —Å–∞–º–∞ —ç—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== –£—Ç–∏–ª–∏—Ç—ã UI ===== */
const $ = (s,r=document)=>r.querySelector(s);
const msg = $("#msg");
const show = (type,text)=>{ msg.className="alert "+(type||""); msg.textContent=text; msg.classList.remove("hidden"); }
const hide = ()=> msg.classList.add("hidden");

/* ===== –õ–û–ì–ò–ö–ê –°–¢–†–ê–ù–ò–¶–´ ===== */
(async function init(){
  // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –ø–∏—Å—å–º–∞ ‚Äî –≤ —Ö—ç—à–µ –±—É–¥–µ—Ç access_token&type=recovery
  // Supabase v2 —Å–æ–∑–¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  try{
    const { data:{ session } } = await supabase.auth.getSession();

    if(session && session.user){
      // –†–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
      $("#who").textContent = session.user.email || session.user.id;
      $("#frmSet").classList.remove("hidden");
    } else {
      // –ù–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Äî –¥–∞—ë–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –µ—â—ë —Ä–∞–∑
      $("#frmAsk").classList.remove("hidden");
    }
  }catch(e){
    $("#frmAsk").classList.remove("hidden");
  }
})();

/* ===== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è ===== */
$("#frmSet").addEventListener("submit", async (e)=>{
  e.preventDefault(); hide();
  const p1 = $("#p1").value.trim();
  const p2 = $("#p2").value.trim();
  if(p1.length<6) return show("", "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.");
  if(p1!==p2)     return show("", "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–æ–¥.");

  try{
    const { error } = await supabase.auth.updateUser({ password: p1 });
    if(error) throw error;
    show("ok","–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω. –í—Ö–æ–¥–∏–º‚Ä¶");
    setTimeout(()=> location.href = INDEX_URL, 700);
  }catch(err){
    show("err","–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å: " + err.message);
  }
});

/* ===== –ó–∞–ø—Ä–æ—Å –ø–∏—Å—å–º–∞ –Ω–∞ —Å–±—Ä–æ—Å, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ===== */
$("#frmAsk").addEventListener("submit", async (e)=>{
  e.preventDefault(); hide();
  const email = $("#ask-email").value.trim();
  if(!email) return show("", "–£–∫–∞–∂–∏—Ç–µ email.");
  try{
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: RESET_URL });
    if(error) throw error;
    show("ok","–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–±—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ " + email + ". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É.");
  }catch(err){
    show("err","–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞: " + err.message);
  }
});
</script>
</body>

</html>
