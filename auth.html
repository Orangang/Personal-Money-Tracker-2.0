<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Вход / Регистрация — Dmitry Money Tracker</title>
<link rel="shortcut icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='42'>₽</text></svg>">
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#111; --muted:#6b7280; --line:#e5e7eb;
  --accent:#2d6cdf; --accent-100:#eef3ff; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.06);
  --fs-base:clamp(14px,1.2vw,16px); --fs-sm:clamp(12px,1.1vw,14px);
}
/* base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:400 var(--fs-base)/1.45 "SF Pro Display",-apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
}
a{color:var(--accent); text-decoration:none}
a:hover{text-decoration:underline}

/* центровка формы */
.wrap{min-height:100vh; min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:20px;}
/* карточка */
.card{
  width:min(480px,94vw);
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:22px 20px;
  margin:0 auto;
}
/* заголовок */
header{display:block; margin-bottom:18px}
h1{margin:0; text-align:center; font-size:clamp(18px,2.4vw,22px); font-weight:700;}

/* табы */
.tabs{display:flex; gap:8px; margin:8px 0 14px}
.tab{flex:1; text-align:center; border:1px solid var(--line); border-radius:10px; padding:8px 12px; cursor:pointer; user-select:none; font-weight:600;}
.tab[aria-selected="true"]{border-color:#2d6cdf; background:#2d6cdf; color:#fff;}

/* инпуты/подписи */
label{font-size:var(--fs-sm); color:var(--muted); display:flex; flex-direction:column; gap:8px; margin-bottom:10px;}
input{width:100%; min-height:42px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font:inherit;}

/* кнопки */
button{border-radius:10px; border:1px solid #d4e1ff; background:#eaf1ff; color:#1f4fbf; font-weight:700; cursor:pointer; transition:border-color .2s,background .2s;}
button.primary{border-color:#2d6cdf; background:#2d6cdf; color:#fff;}
button.ghost{background:#fff; border-color:var(--line); color:#1f1f1f;}
.actions.two{ display:flex; gap:8px; flex-wrap:nowrap; margin-top:16px; }
.actions.two button{ flex:1 1 0; min-height:42px; padding:10px 12px; }
.actions.single{ margin-top:12px; }
.actions.single button{ width:100%; min-height:42px; padding:10px 12px; }

/* разделители */
.form-hr{width:100%; height:1px; background:var(--line); margin:14px auto 0;}
.form-hr.login{  margin:18px auto 0; }
.form-hr.signup{ margin:14px auto 0; }

/* подсказки и алерты */
.help{color:var(--muted); font-size:var(--fs-sm); text-align:left; margin-top:8px}
.help.center{text-align:center; margin-top:12px;}
.alert{padding:10px 12px; border:1px solid #e5e7eb; background:#f9fafb; border-radius:10px; font-size:var(--fs-sm); color:#374151;}
.alert.ok{border-color:#c6f1d3; background:#ecfdf5; color:#065f46}
.alert.err{border-color:#ffd6d6; background:#fff1f1; color:#991b1b}
footer{margin-top:14px; text-align:center; color:var(--muted); font-size:var(--fs-sm);}
.hidden{display:none!important}

/* адаптив */
@media (max-width:420px){
  .card{padding:18px 16px; margin:0 auto;}
  .tabs{gap:6px}
  .tab{padding:7px 10px}
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <header><h1 id="authTitle">Вход</h1></header>

    <div class="tabs" role="tablist">
      <div class="tab" id="tab-login" role="tab" aria-selected="true">Вход</div>
      <div class="tab" id="tab-signup" role="tab" aria-selected="false">Регистрация</div>
    </div>

    <div id="msg" class="alert hidden"></div>

    <!-- форма входа -->
    <form id="login" autocomplete="on">
      <label>Email
        <input type="email" id="login-email" placeholder="you@example.com" required
               autocomplete="username" name="username">
      </label>
      <label>Пароль
        <input type="password" id="login-pass" placeholder="••••••••" minlength="6" required
               autocomplete="current-password" name="current-password">
      </label>
      <div class="actions two">
        <button type="submit" class="primary" id="btnLogin">Войти</button>
        <button type="button" class="ghost" id="btnReset">Сбросить пароль</button>
      </div>
      <div class="form-hr login"></div>
      <div class="help center">Забыли пароль? Пришлём ссылку на почту.</div>
    </form>

    <!-- форма регистрации -->
    <form id="signup" class="hidden" autocomplete="on">
      <label>Email
        <input type="email" id="signup-email" placeholder="you@example.com" required
               autocomplete="username" name="username">
      </label>
      <label>Пароль
        <input type="password" id="signup-pass" placeholder="минимум 6 символов" minlength="6" required
               autocomplete="new-password" name="new-password">
      </label>
      <div class="actions single">
        <button type="submit" class="primary" id="btnSignup">Создать аккаунт</button>
      </div>
      <div class="form-hr signup"></div>
    </form>

    <!-- восстановление пароля -->
    <div id="recovery" class="hidden">
      <div class="alert">Введите новый пароль для аккаунта <b id="rec-email"></b></div>
      <label>Новый пароль
        <input type="password" id="rec-pass" minlength="6" required
               autocomplete="new-password" name="new-password">
      </label>
      <div class="actions single"><button class="primary" id="btnSetNew">Обновить пароль</button></div>
    </div>

    <footer>сделано руками <a href="https://dmitry-design.ru/" target="_blank" rel="noopener">dmitry-design.ru</a></footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =========================
   Supabase + конфиг URL’ов
   ========================= */
const SUPABASE_URL = "https://hxbrvnwukieluzlffgyr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4YnJ2bnd1a2llbHV6bGZmZ3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NTM1NDMsImV4cCI6MjA3NzAyOTU0M30.IWViKSutxlXo1R3DqArijjeseK6nQ9m55ZPe5EUToLQ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const AUTH_URL  = "https://orangang.github.io/Personal-Money-Tracker-2.0/auth.html";
const INDEX_URL = "https://orangang.github.io/Personal-Money-Tracker-2.0/index.html";

/* =========================
   Вспомогалки (UI + storage)
   ========================= */
const $ = (s, r=document) => r.querySelector(s);
const msg = $("#msg");
function show(type, text){ msg.className = "alert " + (type||""); msg.textContent = text; msg.classList.remove("hidden"); }
function hideMsg(){ msg.classList.add("hidden"); }

const tabLogin = $("#tab-login");
const tabSignup = $("#tab-signup");
const frmLogin = $("#login");
const frmSignup = $("#signup");
const recovery = $("#recovery");
const authTitle = $("#authTitle");

tabLogin.onclick = () => {
  tabLogin.setAttribute("aria-selected","true");
  tabSignup.setAttribute("aria-selected","false");
  frmLogin.classList.remove("hidden");
  frmSignup.classList.add("hidden");
  recovery.classList.add("hidden");
  authTitle.textContent = "Вход";
  hideMsg();
};
tabSignup.onclick = () => {
  tabSignup.setAttribute("aria-selected","true");
  tabLogin.setAttribute("aria-selected","false");
  frmSignup.classList.remove("hidden");
  frmLogin.classList.add("hidden");
  recovery.classList.add("hidden");
  authTitle.textContent = "Регистрация";
  hideMsg();
};

/* === Одноразовое локальное сохранение email/password ===
   Храним в localStorage с TTL 24 часа, очищаем после логина */
const PENDING_KEY = "dm_pending_creds";
const PENDING_TTL_MS = 24*60*60*1000; // 24 часа

function savePending(email, pass){
  try{
    localStorage.setItem(PENDING_KEY, JSON.stringify({email, pass, ts: Дате.now()}));
  }catch(e){}
}
function readPending(){
  try{
    const raw = localStorage.getItem(PENDING_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.ts || (Дате.now()-obj.ts)>PENDING_TTL_MS){ clearPending(); return null; }
    return obj;
  }catch(e){ return null; }
}
function clearPending(){ try{ localStorage.removeItem(PENDING_KEY); }catch(e){} }

/* Если уже авторизован — сразу в трекер */
(async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if(session && session.user){
    localStorage.setItem("dm_user_id", session.user.id);
    location.href = INDEX_URL;
  }
})();

/* Регистрация: сохраняем в localStorage и задаём emailRedirectTo */
frmSignup.addEventListener("submit", async (e) => {
  e.preventDefault(); hideMsg();
  const email = $("#signup-email").value.trim();
  const password = $("#signup-pass").value.trim();
  try {
    // 1) Сохраняем для будущей авто-подстановки/входа.
    savePending(email, password);

    // 2) Регистрируем с корректным редиректом
    const { data, error } = await supabase.auth.signUp({
      email, password,
      options:{ emailRedirectTo: AUTH_URL + "#confirm" }
    });
    if(error) throw error;

    show("ok","Аккаунт создан. Подтвердите email в письме, затем вернитесь сюда.");
  } catch(err){
    show("err","Ошибка регистрации: " + err.message);
  }
});

/* Вход: стандартный */
frmLogin.addEventListener("submit", async (e) => {
  e.preventDefault(); hideMsg();
  const email = $("#login-email").value.trim();
  const password = $("#login-pass").value.trim();
  try {
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;
    const user = data.user;
    localStorage.setItem("dm_user_id", user.id);
    await ensureUserRow(user.id, user.email);
    clearPending();
    location.href = INDEX_URL;
  } catch(err){ show("err","Ошибка входа: " + err.message); }
});

/* Сброс пароля с редиректом на наш экран */
$("#btnReset").onclick = async () => {
  hideMsg();
  const email = $("#login-email").value.trim();
  if(!email) return show("", "Укажите email и повторите.");
  try{
    const redirectTo = AUTH_URL + "#recovery";
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
    if(error) throw error;
    show("ok","Ссылка на смену пароля отправлена на " + email);
  }catch(err){ show("err","Не удалось отправить письмо: " + err.message); }
};

/* Экран восстановления пароля */
async function handleRecovery(){
  if(location.hash !== "#recovery") return;
  hideMsg();
  const { data: { session } } = await supabase.auth.getSession();
  if(!(session && session.user)){
    show("err","Ссылка устарела или недействительна.");
    return;
  }
  $("#rec-email").textContent = session.user.email || session.user.id;
  recovery.classList.remove("hidden");
  frmLogin.classList.add("hidden");
  frmSignup.classList.add("hidden");
  authTitle.textContent = "Восстановление пароля";
}
handleRecovery();

/* Установка нового пароля */
$("#btnSetNew").onclick = async () => {
  const pass = $("#rec-pass").value.trim();
  if(pass.length < 6) return show("", "Пароль должен быть не короче 6 символов.");
  try{
    const { error } = await supabase.auth.updateUser({ password: pass });
    if(error) throw error;
    show("ok","Пароль обновлён. Входим…");
    setTimeout(()=> location.href = INDEX_URL, 600);
  }catch(err){ show("err","Ошибка обновления пароля: " + err.message); }
};

/* Поток подтверждения: #confirm → авто-подстановка и авто-вход */
async function handleConfirmFlow(){
  if(location.hash !== "#confirm") return;
  tabLogin.click();
  authTitle.textContent = "Вход";
  show("ok","Email подтверждён. Проверяем данные…");

  const pending = readPending();
  if(pending){
    $("#login-email").value = pending.email || "";
    $("#login-pass").value  = pending.pass  || "";
    try{
      const { data, error } = await supabase.auth.signInWithPassword({ email: pending.email, password: pending.pass });
      if(error) throw error;
      const user = data.user;
      localStorage.setItem("dm_user_id", user.id);
      await ensureUserRow(user.id, user.email);
      clearPending();
      location.href = INDEX_URL;
      return;
    }catch(err){
      show("", "Подтверждение прошло. Проверьте пароль и нажмите «Войти».");
    }
  }else{
    show("", "Подтверждение прошло. Введите пароль и нажмите «Войти».");
  }
}
handleConfirmFlow();

/* На всякий случай — если пользователь вернулся без #confirm,
   но данные ещё валидны, подставим их в форму входа */
(function prefillLoginFromPending(){
  const pending = readPending();
  if(pending){
    if(!$("#login-email").value) $("#login-email").value = pending.email || "";
    if(!$("#login-pass").value)  $("#login-pass").value  = pending.pass  || "";
  }
})();

/* Создание/обновление строки пользователя в БД */
async function ensureUserRow(userId, email){
  try{
    const { data: rows, error: selErr } = await supabase
      .from("users_fintracker").select("id").eq("user_id", userId).limit(1);
    if(selErr) throw selErr;
    if(!rows || rows.length===0){
      const { error: insErr } = await supabase
        .from("users_fintracker").insert({ user_id: userId, email: email||null, data: {} });
      if(insErr) throw insErr;
    } else {
      await supabase.from("users_fintracker").update({ email: email||null }).eq("user_id", userId);
    }
  }catch(err){ console.warn("ensureUserRow:", err.message); }
}

/* Сервисный хук — запомним user_id при любых изменениях */
supabase.auth.onAuthStateChange((_event, session) => {
  if(session && session.user) localStorage.setItem("dm_user_id", session.user.id);
});
</script>
</body>
</html>


<script>
const PENDING_KEY="dm_pending_creds", PENDING_TTL_MS=24*60*60*1000;
function setCookie(n,v,sec){try{document.cookie=n+"="+encodeURIComponent(v)+"; path=/; samesite=lax; max-age="+(sec|0)}catch(e){}}
function getCookie(n){try{const m=document.cookie.match(new RegExp('(?:^|; )'+n.replace(/([.$?*|{}()[\]\\/+^])/g,'\\$1')+'=([^;]*)'));return m?decodeURIComponent(m[1]):""}catch(e){return""}}
function delCookie(n){try{document.cookie=n+"=; path=/; samesite=lax; max-age=0"}catch(e){}}
function savePending(email,pass){
  const json=JSON.stringify({email,pass,ts:Дате.now()});
  try{localStorage.setItem(PENDING_KEY,json)}catch(e){}
  setCookie(PENDING_KEY,btoa(unescape(encodeURIComponent(json))),24*60*60);
}
function readPending(){
  try{const raw=localStorage.getItem(PENDING_KEY); if(raw){const o=JSON.parse(raw); if(o&&o.ts&&(Дате.now()-o.ts)<=PENDING_TTL_MS) return o;}}catch(e){}
  try{const c=getCookie(PENDING_KEY); if(c){const o=JSON.parse(decodeURIComponent(escape(atob(c)))); if(o&&o.ts&&(Дате.now()-o.ts)<=PENDING_TTL_MS) return o;}}catch(e){}
  return null;
}
function clearPending(){ try{localStorage.removeItem(PENDING_KEY)}catch(e){} delCookie(PENDING_KEY); }

async function storeBrowserCredentials(email, pass){
  try{
    if('credentials' in navigator && 'PasswordCredential' in window){
      const cred = new PasswordCredential({ id: email, name: email, password: pass });
      await navigator.credentials.store(cred); // в Chrome/Android показывает «Сохранить пароль»
    }
  }catch(e){}
}
</script>




