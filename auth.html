<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Вход / Регистрация — Dmitry Money Tracker</title>
<link rel="shortcut icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='42'>₽</text></svg>">
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#111; --muted:#6b7280; --line:#e5e7eb;
  --accent:#2d6cdf; --accent-100:#eef3ff; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.06);
  --fs-base:clamp(14px,1.2vw,16px); --fs-sm:clamp(12px,1.1vw,14px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:400 var(--fs-base)/1.45 "SF Pro Display",-apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
}
a{color:var(--accent); text-decoration:none}
a:hover{text-decoration:underline}

.wrap{min-height:100vh; min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:20px;}
.card{width:min(480px,94vw); background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:22px 20px; margin:0 auto;}

header{display:block; margin-bottom:18px}
h1{margin:0; text-align:center; font-size:clamp(18px,2.4vw,22px); font-weight:700;}

.tabs{display:flex; gap:8px; margin:8px 0 14px}
.tab{flex:1; text-align:center; border:1px solid var(--line); border-radius:10px; padding:8px 12px; cursor:pointer; user-select:none; font-weight:600;}
.tab[aria-selected="true"]{border-color:#2d6cdf; background:#2d6cdf; color:#fff;}

label{font-size:var(--fs-sm); color:var(--muted); display:flex; flex-direction:column; gap:8px; margin-bottom:10px}
input{width:100%; min-height:42px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font:inherit;}

button{border-radius:10px; border:1px solid #d4e1ff; background:#eaf1ff; color:#1f4fbf; font-weight:700; cursor:pointer; transition:border-color .2s ease,background .2s ease;}
button.primary{border-color:#2d6cdf; background:#2d6cdf; color:#fff;}
button.ghost{background:#fff; border-color:var(--line); color:#1f1f1f;}

.actions.two{ display:flex; gap:8px; flex-wrap:nowrap; margin-top:16px; }
.actions.two button{ flex:1 1 0; min-height:42px; padding:10px 12px; }
.actions.single{ margin-top:12px; }
.actions.single button{ width:100%; min-height:42px; padding:10px 12px; }

.form-hr{width:100%; height:1px; background:var(--line); margin:14px auto 0;}
.form-hr.login{  margin:18px auto 0; }
.form-hr.signup{ margin:14px auto 0; }

.help{color:var(--muted); font-size:var(--fs-sm); text-align:left; margin-top:8px}
.help.center{ text-align:center; margin-top:12px; }

.alert{padding:10px 12px; border:1px solid #e5e7eb; background:#f9fafb; border-radius:10px; font-size:var(--fs-sm); color:#374151;}
.alert.ok{border-color:#c6f1d3; background:#ecfdf5; color:#065f46}
.alert.err{border-color:#ffd6d6; background:#fff1f1; color:#991b1b}

footer{margin-top:14px; text-align:center; color:var(--muted); font-size:var(--fs-sm);}
.hidden{display:none!important}

/* NEW: блок уведомления о подтверждении */
.notice{
  padding:12px; border:1px dashed #9ec1ff; background:#f5f9ff; border-radius:10px;
  color:#1f3b7a; font-size:var(--fs-sm); margin-bottom:12px;
}
.notice .row{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
.notice .row button{min-height:38px; padding:8px 10px}
@media (max-width:420px){ .card{padding:18px 16px; margin:0 auto;} .tabs{gap:6px} .tab{padding:7px 10px} }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <header><h1 id="authTitle">Вход</h1></header>

    <div class="tabs" role="tablist">
      <div class="tab" id="tab-login" role="tab" aria-selected="true">Вход</div>
      <div class="tab" id="tab-signup" role="tab" aria-selected="false">Регистрация</div>
    </div>

    <div id="msg" class="alert hidden"></div>

    <!-- NEW: уведомление о неподтверждённой почте -->
    <div id="confirmNotice" class="notice hidden">
      <div><b>Подтверди почту</b>, чтобы завершить регистрацию. Мы отправили письмо на <span id="cnEmail"></span>.</div>
      <div class="row">
        <button id="btnResend" class="ghost" type="button">Отправить письмо ещё раз</button>
        <button id="btnOpenAuth" class="primary" type="button">Я подтвердил — войти</button>
      </div>
      <div class="help">После клика по ссылке в письме ты попадёшь на эту страницу, и вход завершится автоматически.</div>
    </div>

    <!-- форма входа -->
    <form id="login" autocomplete="on">
      <label>Email <input type="email" id="login-email" placeholder="you@example.com" required></label>
      <label>Пароль <input type="password" id="login-pass" placeholder="••••••••" minlength="6" required></label>
      <div class="actions two">
        <button type="submit" class="primary" id="btnLogin">Войти</button>
        <button type="button" class="ghost" id="btnReset">Сбросить пароль</button>
      </div>
      <div class="form-hr login"></div>
      <div class="help center">Забыли пароль? Пришлём ссылку на почту.</div>
    </form>

    <!-- форма регистрации -->
    <form id="signup" class="hidden" autocomplete="on">
      <label>Email <input type="email" id="signup-email" placeholder="you@example.com" required></label>
      <label>Пароль <input type="password" id="signup-pass" placeholder="минимум 6 символов" minlength="6" required></label>
      <div class="actions single">
        <button type="submit" class="primary" id="btnSignup">Создать аккаунт</button>
      </div>
      <div class="form-hr signup"></div>
    </form>

    <!-- восстановление пароля -->
    <div id="recovery" class="hidden">
      <div class="alert">Введите новый пароль для аккаунта <b id="rec-email"></b></div>
      <label>Новый пароль <input type="password" id="rec-pass" minlength="6" required></label>
      <div class="actions single"><button class="primary" id="btnSetNew">Обновить пароль</button></div>
    </div>

    <footer>сделано руками <a href="https://dmitry-design.ru/" target="_blank" rel="noopener">dmitry-design.ru</a></footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* === Конфиг === */
const SUPABASE_URL = "https://hxbrvnwukieluzlffgyr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4YnJ2bnd1a2llbHV6bGZmZ3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NTM1NDMsImV4cCI6MjA3NzAyOTU0M30.IWViKSutxlXo1R3DqArijjeseK6nQ9m55ZPe5EUToLQ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const AUTH_URL  = "https://orangang.github.io/Personal-Money-Tracker-2.0/auth.html";
const INDEX_URL = "https://orangang.github.io/Personal-Money-Tracker-2.0/index.html";

/* === Утилиты === */
const $ = (s, r=document) => r.querySelector(s);
const msg = $("#msg");
function show(type, text){ msg.className = "alert " + (type||""); msg.textContent = text; msg.classList.remove("hidden"); }
function hideMsg(){ msg.classList.add("hidden"); }
function getParam(name){ return new URL(location.href).searchParams.get(name); }

/* === Табы === */
const tabLogin = $("#tab-login");
const tabSignup = $("#tab-signup");
const frmLogin = $("#login");
const frmSignup = $("#signup");
const recovery = $("#recovery");
const authTitle = $("#authTitle");
const confirmNotice = $("#confirmNotice");
const cnEmail = $("#cnEmail");

tabLogin.onclick = () => {
  tabLogin.setAttribute("aria-selected","true");
  tabSignup.setAttribute("aria-selected","false");
  frmLogin.classList.remove("hidden");
  frmSignup.classList.add("hidden");
  recovery.classList.add("hidden");
  authTitle.textContent = "Вход";
  hideMsg();
  confirmNotice.classList.add("hidden");
};
tabSignup.onclick = () => {
  tabSignup.setAttribute("aria-selected","true");
  tabLogin.setAttribute("aria-selected","false");
  frmSignup.classList.remove("hidden");
  frmLogin.classList.add("hidden");
  recovery.classList.add("hidden");
  authTitle.textContent = "Регистрация";
  hideMsg();
  confirmNotice.classList.add("hidden");
};

/* === Префилл после регистрации === */
const CRED_KEY = "dm_auth_prefill";
function saveCred(email, pass){ try{ sessionStorage.setItem(CRED_KEY, JSON.stringify({email, pass, ts: Date.now()})); }catch(e){} }
function readCred(){ try{ return JSON.parse(sessionStorage.getItem(CRED_KEY)||"null"); }catch(e){ return null; } }
function clearCred(){ try{ sessionStorage.removeItem(CRED_KEY); }catch(e){} }

/* Если авторизован — в трекер */
(async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if(session && session.user){
    localStorage.setItem("dm_user_id", session.user.id);
    location.href = INDEX_URL;
  }
})();

/* === ОБМЕН КОДА ПОСЛЕ ПОДТВЕРЖДЕНИЯ === */
(async () => {
  if (getParam("code")) {
    try{
      const { data, error } = await supabase.auth.exchangeCodeForSession(window.location.href);
      if(error) throw error;
      clearCred();
      localStorage.setItem("dm_user_id", data.user.id);
      location.replace(INDEX_URL);
      return;
    }catch(err){
      show("err", "Не удалось завершить вход: " + err.message);
    }
  }
  // Подставим сохранённые данные (если есть)
  const cred = readCred();
  if(cred){
    $("#login-email").value = cred.email || "";
    $("#login-pass").value = cred.pass || "";
    cnEmail.textContent = cred.email || "";
    tabLogin.onclick();
  }
})();

/* === Регистрация === */
frmSignup.addEventListener("submit", async (e) => {
  e.preventDefault(); hideMsg();
  const email = $("#signup-email").value.trim();
  const password = $("#signup-pass").value.trim();
  try {
    saveCred(email, password); // чтобы префиллить вход
    const { error } = await supabase.auth.signUp({
      email, password,
      options:{ emailRedirectTo: AUTH_URL } // ключевой момент!
    });
    if(error) throw error;

    // Показываем явное уведомление, префиллируем форму входа
    $("#login-email").value = email;
    $("#login-pass").value = password;
    cnEmail.textContent = email;
    tabLogin.onclick();
    confirmNotice.classList.remove("hidden");
    show("ok","Мы отправили письмо с подтверждением. Открой его и кликни по ссылке.");
  } catch(err){ show("err","Ошибка регистрации: " + err.message); }
});

/* === Вход === */
frmLogin.addEventListener("submit", async (e) => {
  e.preventDefault(); hideMsg();
  const email = $("#login-email").value.trim();
  const password = $("#login-pass").value.trim();
  try {
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;
    const user = data.user;
    localStorage.setItem("dm_user_id", user.id);
    await ensureUserRow(user.id, user.email);
    clearCred();
    location.href = INDEX_URL;
  } catch(err){
    const msgText = (err && err.message) ? String(err.message) : "Ошибка входа";
    if (/email not confirmed/i.test(msgText)) {
      // NEW: показываем блок подтверждения с ресендом
      cnEmail.textContent = $("#login-email").value.trim();
      confirmNotice.classList.remove("hidden");
      show("err","Email not confirmed — проверь почту и подтверди.");
    } else {
      show("err","Ошибка входа: " + msgText);
    }
  }
});

/* === Сброс пароля === */
$("#btnReset").onclick = async () => {
  hideMsg();
  const email = $("#login-email").value.trim();
  if(!email) return show("", "Укажи email и повтори.");
  try{
    const redirectTo = AUTH_URL + "#recovery";
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
    if(error) throw error;
    show("ok","Ссылка на смену пароля отправлена на " + email);
  }catch(err){ show("err","Не удалось отправить письмо: " + err.message); }
};

/* === Кнопки уведомления === */
// Отправить письмо ещё раз
$("#btnResend").onclick = async () => {
  hideMsg();
  let email = $("#login-email").value.trim();
  if(!email){
    const c = readCred(); email = c && c.email ? c.email : "";
  }
  if(!email) return show("", "Укажи email в форме входа.");
  try{
    const { error } = await supabase.auth.resend({ type:"signup", email, options:{ emailRedirectTo: AUTH_URL }});
    if(error) throw error;
    show("ok","Письмо повторно отправлено на " + email);
  }catch(err){ show("err","Не удалось отправить: " + err.message); }
};
// «Я подтвердил — войти» (просто перезагрузим auth.html — если линк уже кликнут, сессия подтянется и перекинем в INDEX)
$("#btnOpenAuth").onclick = async () => {
  hideMsg();
  const { data: { session } } = await supabase.auth.getSession();
  if(session && session.user){ location.href = INDEX_URL; }
  else { location.href = AUTH_URL; } // обновим страницу; если кликали письмо — придёт ?code=... и произойдёт обмен
};

/* === Экран восстановления === */
async function handleRecovery(){
  if(location.hash !== "#recovery") return;
  hideMsg();
  const { data: { session } } = await supabase.auth.getSession();
  if(!(session && session.user)){
    show("err","Ссылка устарела или недействительна.");
    return;
  }
  $("#rec-email").textContent = session.user.email || session.user.id;
  recovery.classList.remove("hidden");
  frmLogin.classList.add("hidden");
  frmSignup.classList.add("hidden");
  authTitle.textContent = "Восстановление пароля";
}
handleRecovery();

$("#btnSetNew").onclick = async () => {
  const pass = $("#rec-pass").value.trim();
  if(pass.length < 6) return show("", "Пароль должен быть не короче 6 символов.");
  try{
    const { error } = await supabase.auth.updateUser({ password: pass });
    if(error) throw error;
    show("ok","Пароль обновлён. Входим…");
    setTimeout(()=> location.href = INDEX_URL, 600);
  }catch(err){ show("err","Ошибка обновления пароля: " + err.message); }
};

/* === Создание строки пользователя в БД === */
async function ensureUserRow(userId, email){
  try{
    const { data: rows, error: selErr } = await supabase
      .from("users_fintracker").select("id").eq("user_id", userId).limit(1);
    if(selErr) throw selErr;
    if(!rows || rows.length===0){
      const { error: insErr } = await supabase
        .from("users_fintracker").insert({ user_id: userId, email: email||null, data: {} });
      if(insErr) throw insErr;
    } else {
      await supabase.from("users_fintracker").update({ email: email||null }).eq("user_id", userId);
    }
  }catch(err){ console.warn("ensureUserRow:", err.message); }
}

/* === Синхронизация === */
supabase.auth.onAuthStateChange((_event, session) => {
  if(session && session.user) localStorage.setItem("dm_user_id", session.user.id);
});
</script>
</body>
</html>
