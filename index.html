<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dmitry — Personal Money Tracker</title>
<link rel="shortcut icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='42'>₽</text></svg>">

<style>
/* === шрифт === */
@font-face{
  font-family:"SF Pro Display";
  font-style:normal;
  font-weight:100 900;
  src:local("SF Pro Display"), local("SFProDisplay-Regular");
  font-display:swap;
}

/* === базовые токены/стили — как в первом коде === */
:root{
  --bg:#fafafa; --card:#ffffff; --ink:#111; --muted:#666; --line:#eaeaea;
  --ok:#1f8b4c; --warn:#cc7a00; --bad:#c0392b; --accent:#2d6cdf;
  --radius:12px; --gap:16px; --shadow:0 2px 10px rgba(0,0,0,.06);
  --fs-base:clamp(14px,1.4vw,16px); --fs-sm:clamp(12px,1.2vw,14px); --fs-lg:clamp(16px,1.6vw,18px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:400 var(--fs-base)/1.45 "SF Pro Display",-apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}
.container{max-width:1200px;margin:0 auto;padding:20px}
h1{font-size:clamp(20px,2.6vw,28px);margin:0 0 12px}
h2{font-size:clamp(18px,2.2vw,22px);margin:0 0 12px}
h3{font-size:clamp(16px,2vw,20px);margin:0 0 10px}
h1,h2,h3{font-weight:600;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-synthesis:none}
.muted{color:var(--muted)}

.row{display:grid;gap:var(--gap)}
@media (min-width:640px){
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  .row.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}
}

.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.card-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
.badge{font-size:var(--fs-sm);padding:2px 8px;border-radius:999px;background:#f2f6ff;border:1px solid #dbe7ff;color:#1f4fbf}

.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.kpi{padding:12px;border:1px solid var(--line);border-radius:10px}
.kpi b{font-size:var(--fs-lg)}

.progress{height:10px;background:#f1f1f1;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,#6aa3ff,#2d6cdf)}

.grid-accounts{display:grid;gap:12px}
@media (min-width:640px){.grid-accounts{grid-template-columns:repeat(5,1fr)}}
.account{border:1px solid var(--line);border-radius:10px;padding:12px}
.account h4{margin:0 0 8px;font-size:var(--fs-lg)}
.account .sum{font-weight:700}
.account .hint{font-size:var(--fs-sm);color:var(--muted)}

label{font-size:var(--fs-sm);color:var(--muted);display:block;margin-bottom:6px}
label>:is(input,select,textarea){margin-top:6px}
input,select,textarea{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:8px;background:#fff;color:#111;font:inherit;min-height:48px}

.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
button{
  display:inline-flex;align-items:center;justify-content:center;
  padding:0 16px;height:44px;min-height:44px;line-height:1;
  border-radius:8px;border:1px solid #d4e1ff;background:#eaf1ff;color:#1f4fbf;font-weight:600;cursor:pointer
}
button.primary{border-color:#2d6cdf;background:#2d6cdf;color:#fff}
button.danger{border-color:#ffddd9;background:#ffeceb;color:#b22a1f}
button.ghost{background:#fff;border-color:var(--line);color:#111}

.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:var(--fs-sm)}
.table th{color:var(--muted);font-weight:600}
.tag{display:inline-block;padding:2px 8px;font-size:var(--fs-sm);border:1px solid var(--line);border-radius:999px}
.help{font-size:var(--fs-sm);color:var(--muted)}
footer{margin:24px 0;text-align:center;color:var(--muted);font-size:var(--fs-sm)}

details.modal{border:1px solid var(--line);border-radius:var(--radius);padding:12px}
details.modal>summary{cursor:pointer;list-style:none;font-weight:700}
details.modal>summary::-webkit-details-marker{display:none}
.summary-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.summary-row small{color:var(--muted)}

/* iOS/WebKit фиксы для date/month/select */
input[type="date"],input[type="month"]{
  -webkit-appearance:none;appearance:none;width:100%;
  min-height:48px;line-height:1.2;padding:12px 14px;border:1px solid var(--line);border-radius:8px;background:#fff;font:inherit
}
input[type="date"]::-webkit-date-and-time-value,
input[type="month"]::-webkit-date-and-time-value{ text-align:left }
select{-webkit-appearance:none;appearance:none;min-height:48px;line-height:1.2;padding:12px 14px;font:inherit;background:#fff;border:1px solid var(--line);border-radius:8px}

/* Кнопки под заголовками — одна строка, скролл на мобиле */
@media (max-width:640px){
  .card .card-title{flex-direction:column;align-items:flex-start}
  .card .card-title .controls{width:100%;overflow:auto}
  input,select,textarea{font-size:16px} /* анти-зуум iOS */
}
.card .card-title .controls button{white-space:nowrap;flex:0 0 auto}

/* === AUTH — центр и узкая форма === */
#authCard{max-width:760px;margin:0 auto}                  /* карточка уже и по центру */
#authCard .auth-wrap{padding:0 40px 16px}                 /* нужные 40px слева/справа */
#authCard .auth-grid{display:grid;grid-template-columns:1fr;gap:var(--gap);justify-items:center}
#authCard label{max-width:520px;width:100%}               /* поля уже */
#authCard .controls{justify-content:center}               /* кнопки по центру */

/* Видимость приложения */
.app-only{display:none}
body.signed .app-only{display:block}
body.signed #authCard{display:none !important}

/* Toasts */
#toast-root{position:fixed;right:16px;top:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:#fff;border:1px solid var(--line);border-left-width:4px;border-radius:10px;box-shadow:var(--shadow);padding:10px 12px;min-width:240px;max-width:min(92vw,420px);font-size:var(--fs-sm);display:flex;align-items:flex-start;gap:10px}
.toast.ok{border-left-color:var(--ok)} .toast.warn{border-left-color:var(--warn)} .toast.err{border-left-color:var(--bad)}
.toast .title{font-weight:700;margin-bottom:4px} .toast .msg{color:var(--muted);white-space:pre-line} .toast .close{margin-left:auto;cursor:pointer;opacity:.6}
@media(max-width:640px){#toast-root{right:10px;top:10px}}

/* === Операции в 3 колонки (строго) === */
.ops{display:grid;gap:var(--gap)}
@media (min-width:960px){ .ops{grid-template-columns:repeat(3,1fr)} }
.ops .card{height:100%}
.header-right{display:flex;align-items:center;gap:8px}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  window.SUPABASE_URL = "https://zqoobfeogfiehutdzsbg.supabase.co";
  window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpxb29iZmVvZ2ZpZWh1dGR6c2JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjI5MjQsImV4cCI6MjA3Njk5ODkyNH0.4yZqT-y81ZIx933yb-9lOR8CMKh-ebRcWNnh4r1vrlE";
</script>
</head>
<body>
<div class="container">
  <header style="margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div>
      <h1>Личный финтрекер Дмитрия</h1>
      <div class="muted">Локально + облачная синхронизация • Supabase Auth • экспорт/импорт JSON</div>
    </div>
    <div class="header-right">
      <span class="badge" id="authStatus">offline</span>
      <button class="ghost" id="btnSignOutHeader" style="display:none">Сменить аккаунт</button>
    </div>
  </header>

  <div id="toast-root" aria-live="polite"></div>

  <!-- AUTH -->
  <section class="card" id="authCard" style="margin-bottom:16px">
    <div class="auth-wrap">
      <div class="card-title" style="margin-bottom:6px">
        <h2 style="margin:0">Вход</h2>
      </div>

      <div class="tabs">
        <button class="active" data-mode="login">Войти</button>
        <button data-mode="signup">Регистрация</button>
      </div>

      <!-- широкие поля -->
      <div class="auth-grid">
        <label>E-mail <input type="email" id="authEmail" placeholder="you@example.com"></label>
        <label>Пароль <input type="password" id="authPass" placeholder="••••••••"></label>
      </div>

      <div class="controls">
        <button class="primary" id="btnPrimaryAuth">Войти</button>
        <button id="btnReset">Забыли пароль?</button>
      </div>
      <div class="help" id="authHelp">Вход нужен, чтобы хранить данные в облаке и видеть их на любых устройствах.</div>

      <div id="pwRecovery" style="display:none;margin-top:12px">
        <hr>
        <label>Новый пароль <input type="password" id="newPass" placeholder="Новый пароль"></label>
        <div class="controls"><button class="primary" id="btnSetNewPass">Сохранить пароль</button></div>
      </div>
    </div>
  </section>

  <!-- DASHBOARD (в одну колонку, во всю ширину) -->
  <section class="card app-only">
    <div class="card-title">
      <h2 style="margin:0">Дашборд</h2>
      <span class="badge" id="currentMonthBadge"></span>
    </div>

    <div class="kpis" style="margin-bottom:12px">
      <div class="kpi"><div class="muted">Доходы (месяц)</div><b id="kpiIncomeMonth">—</b></div>
      <div class="kpi"><div class="muted">Расходы (месяц)</div><b id="kpiExpenseMonth">—</b></div>
      <div class="kpi"><div class="muted">Траты сегодня</div><b id="kpiToday">—</b></div>
      <div class="kpi"><div class="muted">Баланс всех счетов</div><b id="kpiTotal">—</b></div>
    </div>

    <div class="grid-accounts" id="accountsGrid"></div>

    <div style="margin-top:12px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:6px">
        <div class="muted">Прогресс погашения долга</div>
        <div class="muted" id="debtLabel">—</div>
      </div>
      <div class="progress"><i id="debtProgress" style="width:0%"></i></div>
    </div>
  </section>

  <!-- Операции: ровно 3 столбца -->
  <section class="ops app-only" style="margin-top:16px">
    <div class="card">
      <h3>Добавить доход</h3>
      <label>Дата <input type="date" id="incDate"></label>
      <label>Сумма ₽ <input type="number" id="incAmount" min="0" step="0.01" placeholder="Напр. 100000"></label>
      <label>Категория <input type="text" id="incCategory" placeholder="Зарплата / Фриланс"></label>
      <label>Заметка <input type="text" id="incNote" placeholder="Опционально"></label>
      <div class="help">Доход распределится по 4 счетам согласно долям в настройках.</div>
      <div class="controls">
        <button class="primary" id="btnAddIncome">Добавить</button>
        <button class="ghost" id="btnPreviewSplit">Посмотреть распределение</button>
      </div>
      <div id="splitPreview" class="help" style="display:none;margin-top:6px"></div>
    </div>

    <div class="card">
      <h3>Добавить расход</h3>
      <label>Дата <input type="date" id="expDate"></label>
      <label>Сумма ₽ <input type="number" id="expAmount" min="0" step="0.01" placeholder="Напр. 2500"></label>
      <label>Счёт
        <select id="expAcc">
          <option value="base">Базовый</option>
          <option value="fixed">Расходный</option>
          <option value="fun">Весёлый</option>
          <option value="save">Накопления</option>
        </select>
      </label>
      <label>Категория <input type="text" id="expCategory" placeholder="Еда / Подписки / Транспорт"></label>
      <label>Заметка <input type="text" id="expNote" placeholder="Опционально"></label>
      <div class="controls"><button class="primary" id="btnAddExpense">Добавить</button></div>
    </div>

    <div class="card">
      <h3>Переводы и долг</h3>
      <details class="modal" style="margin-bottom:8px" open>
        <summary class="summary-row">Перевод между счетами <small>внутренний</small></summary>
        <div class="row" style="margin-top:8px">
          <div><label>Дата <input type="date" id="trDate"></label></div>
          <div><label>Сумма ₽ <input type="number" id="trAmount" min="0" step="0.01"></label></div>
        </div>
        <div class="row cols-2">
          <label>Откуда
            <select id="trFrom">
              <option value="base">Базовый</option><option value="fixed">Расходный</option><option value="fun">Весёлый</option><option value="save">Накопления</option>
            </select>
          </label>
          <label>Куда
            <select id="trTo">
              <option value="base">Базовый</option><option value="fixed">Расходный</option><option value="fun">Весёлый</option><option value="save">Накопления</option>
            </select>
          </label>
        </div>
        <label>Заметка <input type="text" id="trNote" placeholder="Опционально"></label>
        <div class="controls"><button class="primary" id="btnTransfer">Перевести</button></div>
      </details>

      <details class="modal">
        <summary class="summary-row">Платёж по долгу <small>фиксируется прогресс</small></summary>
        <div class="row" style="margin-top:8px">
          <div><label>Дата <input type="date" id="debtDate"></label></div>
          <div><label>Сумма ₽ <input type="number" id="debtPayAmount" min="0" step="0.01"></label></div>
        </div>
        <label>Списать с счёта (опционально)
          <select id="debtFrom">
            <option value="">— не списывать —</option><option value="base">Базовый</option><option value="fixed">Расходный</option><option value="fun">Весёлый</option><option value="save">Накопления</option>
          </select>
        </label>
        <label>Заметка <input type="text" id="debtNote" placeholder="Опционально"></label>
        <div class="controls"><button class="primary" id="btnDebtPay">Учесть платёж</button><button class="ghost" id="btnDebtReset">Сбросить прогресс</button></div>
      </details>
    </div>
  </section>

  <!-- Транзакции (в одну колонку) -->
  <section class="card app-only" style="margin-top:16px">
    <div class="card-title">
      <h2 style="margin:0">Транзакции</h2>
      <div class="controls">
        <button id="btnExport">Экспорт JSON</button>
        <label style="display:inline-flex;align-items:center;gap:8px">
          <input type="file" id="fileImport" accept="application/json" style="display:none">
          <button class="ghost" id="btnImport">Импорт JSON</button>
        </label>
        <button class="danger" id="btnWipe">Стереть всё</button>
      </div>
    </div>

    <div class="row cols-4" style="margin-bottom:8px">
      <label>Месяц <input type="month" id="fltMonth"></label>
      <label>Тип
        <select id="fltType">
          <option value="">Все</option><option value="income">Доход</option><option value="expense">Расход</option><option value="transfer">Перевод</option><option value="debt">Долг</option>
        </select>
      </label>
      <label>Счёт
        <select id="fltAcc">
          <option value="">Все</option><option value="base">Базовый</option><option value="fixed">Расходный</option><option value="fun">Весёлый</option><option value="save">Накопления</option>
        </select>
      </label>
      <label>Поиск <input type="text" id="fltSearch" placeholder="категория/заметка"></label>
    </div>

    <div class="row cols-2">
      <div class="help" id="listInfo">—</div>
      <div style="text-align:right" class="help"><span class="tag">сегодня: <b id="todayStr">—</b></span></div>
    </div>

    <div style="overflow:auto">
      <table class="table" id="txTable">
        <thead><tr><th>Дата</th><th>Тип</th><th>Счета</th><th>Сумма</th><th>Категория</th><th>Заметка</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Настройки (в одну колонку) -->
  <section class="card app-only" style="margin-top:16px">
    <h2>Настройки</h2>
    <div class="row cols-4">
      <label>Базовый ₽ <input type="number" id="stBase" min="0" step="0.01"></label>
      <label>Расходный ₽ <input type="number" id="stFixed" min="0" step="0.01"></label>
      <label>Весёлый ₽ <input type="number" id="stFun" min="0" step="0.01"></label>
      <label>Накопления ₽ <input type="number" id="stSave" min="0" step="0.01"></label>
    </div>
    <div class="row cols-4" style="margin-top:8px">
      <label>Сумма долга ₽ <input type="number" id="stDebtTotal" min="0" step="0.01"></label>
      <label>Уже погашено ₽ <input type="number" id="stDebtPaid" min="0" step="0.01"></label>
      <label>Начало месяца (день) <input type="number" id="stMonthStart" min="1" max="28"></label>
    </div>
    <h3 style="margin-top:12px">Доли авто-раскидки дохода (%)</h3>
    <div class="row cols-4">
      <label>Базовый % <input type="number" id="spBase" min="0" max="100"></label>
      <label>Расходный % <input type="number" id="spFixed" min="0" max="100"></label>
      <label>Весёлый % <input type="number" id="spFun" min="0" max="100"></label>
      <label>Накопления % <input type="number" id="spSave" min="0" max="100"></label>
    </div>
    <div class="help" id="splitSumHelp" style="margin-top:6px">Сумма долей должна быть 100%.</div>
    <div class="controls">
      <button class="primary" id="btnSaveSettings">Сохранить настройки</button>
      <button class="ghost" id="btnFillDemo">Загрузить демо-данные</button>
    </div>
  </section>

  <footer class="app-only">v2 • локальное хранение + Supabase синк • сделано под тебя</footer>
</div>

<script>
(() => {
  "use strict";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});
  let CURRENT_USER=null;

  const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const fmtRUB=n=>(Number(n)||0).toLocaleString('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0});
  const fmtNum=(n,d=2)=>(Number(n)||0).toLocaleString('ru-RU',{minimumFractionDigits:d,maximumFractionDigits:d});
  const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  const todayISO=()=>new Date().toISOString().slice(0,10);
  const monthStr=(d=new Date())=>d.toLocaleString('ru-RU',{month:'long',year:'numeric'});
  const uid=()=> (crypto.randomUUID?crypto.randomUUID():(Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4)));
  const round=n=>Math.round((Number(n)||0));
  const LS_KEY='dm_fin_v1';

  function toast(type,title,msg,timeout=4200){
    const root=$('#toast-root'); if(!root) return alert(title+"\n"+(msg||''));
    const el=document.createElement('div'); el.className='toast '+type;
    el.innerHTML='<div><div class="title">'+title+'</div>'+(msg?'<div class="msg">'+msg+'</div>':'')+'</div><div class="close">✕</div>';
    root.appendChild(el); const close=()=>{el.style.opacity='0';setTimeout(()=>el.remove(),200)};
    el.querySelector('.close').onclick=close; setTimeout(close,timeout);
  }

  function setSigned(signed){
    document.body.classList.toggle('signed',!!signed);
    const b=$('#authStatus'); if(b) b.textContent=signed?'online':'offline';
    $('#btnSignOutHeader').style.display=signed?'inline-flex':'none';
  }

  let state=load();
  function load(){
    try{const raw=localStorage.getItem(LS_KEY); if(raw) return JSON.parse(raw);}catch(e){}
    return {settings:{accounts:{base:0,fixed:0,fun:0,save:0,debtTotal:0,debtPaid:0},autosplit:{base:40,fixed:30,fun:10,save:20},monthStartDay:1},transactions:[]};
  }
  function save(){localStorage.setItem(LS_KEY,JSON.stringify(state));}

  async function ensureProfileAndSettings(user){
    await supa.from('profiles').upsert({id:user.id,email:user.email},{onConflict:'id'});
    const {data:s}=await supa.from('settings').select('*').eq('user_id',user.id).maybeSingle();
    if(!s){await supa.from('settings').insert({user_id:user.id,accounts:state.settings.accounts,autosplit:state.settings.autosplit,month_start_day:state.settings.monthStartDay});}
  }
  async function loadFromCloud(){
    if(!CURRENT_USER) return false; const uid=CURRENT_USER.id;
    const [{data:setRow},{data:txRows}] = await Promise.all([
      supa.from('settings').select('*').eq('user_id',uid).maybeSingle(),
      supa.from('transactions').select('*').eq('user_id',uid).order('date',{ascending:false})
    ]);
    if(setRow){
      state.settings.accounts=setRow.accounts||state.settings.accounts;
      state.settings.autosplit=setRow.autosplit||state.settings.autosplit;
      state.settings.monthStartDay=setRow.month_start_day||state.settings.monthStartDay;
    }
    if(Array.isArray(txRows)){
      state.transactions=txRows.map(r=>({id:r.id,date:r.date,type:r.type,account:r.account||undefined,fromAccount:r.from_account||undefined,toAccount:r.to_account||undefined,amount:Number(r.amount),category:r.category||undefined,note:r.note||undefined}));
    }
    save(); return true;
  }
  async function saveSettingsToCloud(){ if(!CURRENT_USER) return; await supa.from('settings').upsert({user_id:CURRENT_USER.id,accounts:state.settings.accounts,autosplit:state.settings.autosplit,month_start_day:state.settings.monthStartDay,updated_at:new Date().toISOString()},{onConflict:'user_id'}); }
  async function upsertTxToCloud(tx){ if(!CURRENT_USER) return; await supa.from('transactions').upsert({id:tx.id,user_id:CURRENT_USER.id,date:tx.date,type:tx.type,account:tx.account||null,from_account:tx.fromAccount||null,to_account:tx.toAccount||null,amount:tx.amount,category:tx.category||null,note:tx.note||null}); }
  async function deleteTxInCloud(id){ if(!CURRENT_USER) return; await supa.from('transactions').delete().eq('id',id); }
  async function maybeBootstrapCloudFromLocal(){
    if(!CURRENT_USER) return;
    const {data:exists}=await supa.from('transactions').select('id').eq('user_id',CURRENT_USER.id).limit(1);
    if(!exists||exists.length===0){
      if(state.transactions.length){
        const bulk=state.transactions.map(t=>({id:t.id,user_id:CURRENT_USER.id,date:t.date,type:t.type,account:t.account||null,from_account:t.fromAccount||null,to_account:t.toAccount||null,amount:t.amount,category:t.category||null,note:t.note||null}));
        await supa.from('transactions').insert(bulk);
      }
      await saveSettingsToCloud();
    }
  }

  // Auth UI
  let authMode='login';
  function applyAuthMode(){
    $$('.tabs button').forEach(btn=>btn.classList.toggle('active',btn.dataset.mode===authMode));
    $('#btnPrimaryAuth').textContent=authMode==='login'?'Войти':'Зарегистрироваться';
    $('#authHelp').textContent=authMode==='login'?'Вход нужен, чтобы хранить данные в облаке и видеть их на любых устройствах.':'Создайте аккаунт, затем войдите. Если требуется подтверждение, проверьте почту.';
  }
  applyAuthMode();
  $$('.tabs button').forEach(b=>b.addEventListener('click',()=>{authMode=b.dataset.mode;applyAuthMode();}));

  // Немедленный выход
  document.getElementById('btnSignOutHeader').addEventListener('click',async()=>{
    try{await supa.auth.signOut();CURRENT_USER=null;setSigned(false);toast('ok','Вы вышли из аккаунта');}
    catch(err){toast('err','Ошибка выхода',err.message||String(err));}
  });

  document.getElementById('btnPrimaryAuth').addEventListener('click',async()=>{
    try{
      const email=$('#authEmail').value.trim(); const pass=$('#authPass').value;
      if(!email||!pass) return toast('warn','Нужно заполнить','E-mail и пароль обязательны.');
      if(authMode==='login'){
        const {data,error}=await supa.auth.signInWithPassword({email,password:pass});
        if(error) throw error; CURRENT_USER=data.user;
        await ensureProfileAndSettings(CURRENT_USER); await maybeBootstrapCloudFromLocal(); await loadFromCloud();
        renderAll(); setSigned(true); toast('ok','Вход выполнен');
      }else{
        const {data,error}=await supa.auth.signUp({email,password:pass});
        if(error) throw error;
        if(data.user){ CURRENT_USER=data.user; await ensureProfileAndSettings(CURRENT_USER); await maybeBootstrapCloudFromLocal(); await loadFromCloud(); renderAll(); setSigned(true); toast('ok','Аккаунт создан и вход выполнен'); }
        else{ authMode='login'; applyAuthMode(); $('#authEmail').value=email; toast('ok','Аккаунт создан','Проверь почту и войди.'); }
      }
    }catch(err){
      const msg=(err&&(err.message||err.error_description))||String(err);
      if(/Failed to fetch/i.test(msg)) toast('err','Нет связи с Supabase','Проверь свой проект/Redirect URLs/ANON ключ.');
      else toast('err','Ошибка',msg);
    }
  });

  document.getElementById('btnReset').addEventListener('click',async()=>{
    const email=$('#authEmail').value.trim(); if(!email) return toast('warn','Укажи e-mail для сброса');
    const {error}=await supa.auth.resetPasswordForEmail(email,{redirectTo:location.origin+location.pathname+'#recovery'});
    if(error) toast('err','Ошибка',error.message||String(error)); else toast('ok','Письмо отправлено','Проверь почту.');
  });

  document.getElementById('btnSetNewPass').addEventListener('click',async()=>{
    const np=$('#newPass').value; if(!np||np.length<6) return toast('warn','Слабый пароль','Минимум 6 символов.');
    const {error}=await supa.auth.updateUser({password:np});
    if(error) toast('err','Ошибка',error.message||String(error)); else { $('#pwRecovery').style.display='none'; toast('ok','Пароль обновлён','Войдите новой парой.'); }
  });

  supa.auth.onAuthStateChange(async (event, session)=>{
    CURRENT_USER=session?.user||null;
    if(event==='PASSWORD_RECOVERY'){ $('#pwRecovery').style.display='block'; setSigned(false); return; }
    setSigned(!!CURRENT_USER);
    if(CURRENT_USER){ try{ await ensureProfileAndSettings(CURRENT_USER); await loadFromCloud(); renderAll(); } catch(err){ toast('err','Ошибка загрузки',err.message||String(err)); } }
  });

  // Инициализация дат
  $('#incDate').value=todayISO(); $('#expDate').value=todayISO(); $('#trDate').value=todayISO(); $('#debtDate').value=todayISO();
  $('#fltMonth').value=new Date().toISOString().slice(0,7);

  // Настройки UI
  function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
  function updateSplitSumHelp(){
    const sum=['base','fixed','fun','save'].reduce((s,k)=>s+Number($('#sp'+cap(k)).value||0),0);
    $('#splitSumHelp').textContent=`Сумма долей: ${sum}% (должно быть 100%).`;
    $('#splitSumHelp').style.color=(sum===100)?'var(--muted)':'var(--bad)';
  }
  function fillSettingsUI(){
    const A=state.settings.accounts;
    $('#stBase').value=A.base; $('#stFixed').value=A.fixed; $('#stFun').value=A.fun; $('#stSave').value=A.save;
    $('#stDebtTotal').value=A.debtTotal; $('#stDebtPaid').value=A.debtPaid; $('#stMonthStart').value=state.settings.monthStartDay;
    $('#spBase').value=state.settings.autosplit.base; $('#spFixed').value=state.settings.autosplit.fixed; $('#spFun').value=state.settings.autosplit.fun; $('#spSave').value=state.settings.autosplit.save;
    updateSplitSumHelp();
  }
  ['spBase','spFixed','spFun','spSave'].forEach(id=>$('#'+id).addEventListener('input',updateSplitSumHelp));

  // Дашборд / таблица
  function labelAcc(k){return ({base:'Базовый',fixed:'Расходный',fun:'Весёлый',save:'Накопления'})[k]||'—';}
  function labelType(t){return ({income:'Доход',expense:'Расход',transfer:'Перевод',debt:'Долг'})[t]||t;}

  function renderDashboard(){
    $('#currentMonthBadge').textContent=monthStr(new Date());
    const A=state.settings.accounts;
    const accs=[{key:'base',title:'Базовый',hint:'зарплата'},{key:'fixed',title:'Расходный',hint:'фикс. платежи'},{key:'fun',title:'Весёлый',hint:'удовольствия'},{key:'save',title:'Накопления',hint:'цели/подушка'},{key:'debt',title:'Долг',hint:'остаётся'}];
    const grid=$('#accountsGrid'); grid.innerHTML='';
    accs.forEach(a=>{
      const val=(a.key==='debt')?Math.max(A.debtTotal-A.debtPaid,0):A[a.key];
      const div=document.createElement('div'); div.className='account';
      div.innerHTML='<h4>'+a.title+'</h4><div class="sum">'+fmtRUB(val)+'</div><div class="hint">'+a.hint+'</div>';
      grid.appendChild(div);
    });
    const pct=(A.debtTotal>0)?clamp((A.debtPaid/A.debtTotal)*100,0,100):0;
    $('#debtProgress').style.width=pct.toFixed(1)+'%';
    $('#debtLabel').textContent=fmtRUB(A.debtPaid)+' из '+fmtRUB(A.debtTotal)+' ('+pct.toFixed(1)+'%)';

    const month=$('#fltMonth').value||new Date().toISOString().slice(0,7);
    const listM=state.transactions.filter(t=>(t.date||'').startsWith(month));
    const sumIncome=listM.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const sumExpense=listM.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    $('#kpiIncomeMonth').textContent=fmtRUB(sumIncome);
    $('#kpiExpenseMonth').textContent=fmtRUB(sumExpense);
    const tISO=todayISO();
    const todayExp=state.transactions.filter(t=>t.type==='expense'&&t.date===tISO).reduce((s,t)=>s+t.amount,0);
    $('#kpiToday').textContent=fmtRUB(todayExp);
    const totalBal=A.base+A.fixed+A.fun+A.save; $('#kpiTotal').textContent=fmtRUB(totalBal);
    $('#todayStr').textContent=new Date().toLocaleDateString('ru-RU');
  }

  function renderTable(){
    const month=$('#fltMonth').value||new Date().toISOString().slice(0,7);
    const tp=$('#fltType').value, acc=$('#fltAcc').value, q=($('#fltSearch').value||'').trim().toLowerCase();

    let list=state.transactions.slice().sort((a,b)=>a.date>b.date?-1:a.date<b.date?1:0);
    list=list.filter(t=>(t.date||'').startsWith(month));
    if(tp) list=list.filter(t=>t.type===tp);
    if(acc) list=list.filter(t=>(t.account===acc||t.fromAccount===acc||t.toAccount===acc));
    if(q) list=list.filter(t=>((t.category||'')+(t.note||'')).toLowerCase().includes(q));

    const tbody=$('#txTable tbody'); tbody.innerHTML='';
    for(const t of list){
      const accounts=t.type==='transfer'?(labelAcc(t.fromAccount)+' → '+labelAcc(t.toAccount)):
                     t.type==='income'?(labelAcc(t.account)+' (+)'):
                     t.type==='expense'?(labelAcc(t.account)+' (−)'):
                     t.type==='debt'?('Долг'+(t.account?' (− '+labelAcc(t.account)+')':'')):'—';
      const tr=document.createElement('tr');
      tr.innerHTML='<td>'+t.date+'</td>'+
                   '<td><span class="tag">'+labelType(t.type)+'</span></td>'+
                   '<td>'+accounts+'</td>'+
                   '<td style="white-space:nowrap">'+((t.type==='expense'||(t.type==='transfer'&&t.fromAccount))?'-':'')+fmtNum(t.amount,0)+' ₽</td>'+
                   '<td>'+(t.category||'—')+'</td>'+
                   '<td>'+(t.note||'')+'</td>'+
                   '<td style="text-align:right"><button class="ghost" data-del="'+t.id+'">✕</button></td>';
      tbody.appendChild(tr);
    }
    $('#listInfo').textContent='Показано: '+list.length+' операций. Всего в базе: '+state.transactions.length+'.';
    $$('button[data-del]').forEach(btn=>{
      btn.onclick=async()=>{const id=btn.getAttribute('data-del'); state.transactions=state.transactions.filter(t=>t.id!==id); save(); renderAll(); await deleteTxInCloud(id);};
    });
  }

  // Автораскидка
  function incomeSplit(amount){
    const s=state.settings.autosplit;
    const parts={base:round(amount*(s.base/100)),fixed:round(amount*(s.fixed/100)),fun:round(amount*(s.fun/100)),save:round(amount*(s.save/100))};
    const sum=parts.base+parts.fixed+parts.fun+parts.save; const delta=round(amount-sum); if(delta!==0) parts.base+=delta; return parts;
  }

  // Операции
  $('#btnPreviewSplit').onclick=()=>{
    const amount=Number($('#incAmount').value||0);
    if(!amount){$('#splitPreview').style.display='none';return;}
    const p=incomeSplit(amount);
    $('#splitPreview').style.display='block';
    $('#splitPreview').textContent=`Распределение: Базовый ${fmtRUB(p.base)}, Расходный ${fmtRUB(p.fixed)}, Весёлый ${fmtRUB(p.fun)}, Накопления ${fmtRUB(p.save)}.`;
  };

  $('#btnAddIncome').onclick=async()=>{
    const date=$('#incDate').value||todayISO();
    const amount=Number($('#incAmount').value||0);
    const category=$('#incCategory').value||'Доход';
    const note=$('#incNote').value||'';
    if(amount<=0) return alert('Введите сумму дохода > 0');

    const split=incomeSplit(amount);
    const txs=[];
    for(const k of ['base','fixed','fun','save']){
      if(split[k]>0){
        const tx={id:uid(),date,type:'income',account:k,amount:split[k],category,note};
        txs.push(tx); state.settings.accounts[k]+=split[k]; await upsertTxToCloud(tx);
      }
    }
    state.transactions.push(...txs); save(); await saveSettingsToCloud();
    $('#incAmount').value=''; $('#incNote').value=''; $('#splitPreview').style.display='none'; renderAll();
  };

  $('#btnAddExpense').onclick=async()=>{
    const date=$('#expDate').value||todayISO();
    const amount=Number($('#expAmount').value||0);
    const account=$('#expAcc').value;
    const category=$('#expCategory').value||'Расход';
    const note=$('#expNote').value||'';
    if(amount<=0) return alert('Введите сумму расхода > 0');
    if(state.settings.accounts[account]<amount){ if(!confirm('На счёте не хватает средств. Продолжить?')) return; }
    const tx={id:uid(),date,type:'expense',account,amount,category,note};
    state.transactions.push(tx); state.settings.accounts[account]-=amount; save(); await upsertTxToCloud(tx); await saveSettingsToCloud();
    $('#expAmount').value=''; $('#expNote').value=''; renderAll();
  };

  $('#btnTransfer').onclick=async()=>{
    const date=$('#trDate').value||todayISO();
    const amount=Number($('#trAmount').value||0);
    const from=$('#trFrom').value; const to=$('#trTo').value; const note=$('#trNote').value||'';
    if(amount<=0) return alert('Введите сумму перевода > 0');
    if(from===to) return alert('Выберите разные счета');
    if(state.settings.accounts[from]<amount){ if(!confirm('На счёте-источнике не хватает средств. Продолжить?')) return; }
    const tx={id:uid(),date,type:'transfer',fromAccount:from,toAccount:to,amount,category:'Перевод',note};
    state.transactions.push(tx); state.settings.accounts[from]-=amount; state.settings.accounts[to]+=amount;
    save(); await upsertTxToCloud(tx); await saveSettingsToCloud(); $('#trAmount').value=''; $('#trNote').value=''; renderAll();
  };

  $('#btnDebtPay').onclick=async()=>{
    const date=$('#debtDate').value||todayISO();
    const amount=Number($('#debtPayAmount').value||0);
    const from=$('#debtFrom').value; const note=$('#debtNote').value||'';
    if(amount<=0) return alert('Введите сумму платежа > 0');
    const tx={id:uid(),date,type:'debt',amount,account:from||undefined,category:'Платёж по долгу',note};
    state.transactions.push(tx);
    if(from){ if(state.settings.accounts[from]<amount){ if(!confirm('На счёте не хватает средств. Продолжить?')) return; } state.settings.accounts[from]-=amount; }
    state.settings.accounts.debtPaid=clamp(round(state.settings.accounts.debtPaid+amount),0,round(state.settings.accounts.debtTotal));
    save(); await upsertTxToCloud(tx); await saveSettingsToCloud(); $('#debtPayAmount').value=''; $('#debtNote').value=''; renderAll();
  };

  $('#btnDebtReset').onclick=async()=>{ if(confirm('Сбросить прогресс погашения долга?')){ state.settings.accounts.debtPaid=0; save(); await saveSettingsToCloud(); renderAll(); } };

  // Фильтры
  $('#fltMonth').oninput=()=>{renderDashboard();renderTable();};
  $('#fltType').oninput=renderTable; $('#fltAcc').oninput=renderTable; $('#fltSearch').oninput=renderTable;

  // Настройки
  $('#btnSaveSettings').onclick=async()=>{
    const A=state.settings.accounts;
    A.base=Number($('#stBase').value||0); A.fixed=Number($('#stFixed').value||0); A.fun=Number($('#stFun').value||0); A.save=Number($('#stSave').value||0);
    A.debtTotal=Number($('#stDebtTotal').value||0); A.debtPaid=Number($('#stDebtPaid').value||0);
    state.settings.autosplit={base:Number($('#spBase').value||0),fixed:Number($('#spFixed').value||0),fun:Number($('#spFun').value||0),save:Number($('#spSave').value||0)};
    state.settings.monthStartDay=clamp(Number($('#stMonthStart').value||1),1,28);
    const sum=Object.values(state.settings.autosplit).reduce((s,n)=>s+Number(n||0),0);
    if(sum!==100) return alert('Сумма долей должна быть 100%.');
    save(); await saveSettingsToCloud(); renderAll(); toast('ok','Настройки сохранены');
  };

  $('#btnFillDemo').onclick=async()=>{
    if(!confirm('Загрузить демо-данные и перезаписать текущие?')) return;
    state={settings:{accounts:{base:35000,fixed:20000,fun:7000,save:45000,debtTotal:300000,debtPaid:65000},autosplit:{base:40,fixed:30,fun:10,save:20},monthStartDay:1},
      transactions:[
        {id:uid(),date:isoShift(-25),type:'income',account:'base',amount:60000,category:'Зарплата',note:'автосплит'},
        {id:uid(),date:isoShift(-25),type:'income',account:'fixed',amount:45000,category:'Зарплата',note:'автосплит'},
        {id:uid(),date:isoShift(-25),type:'income',account:'fun',amount:15000,category:'Зарплата',note:'автосплит'},
        {id:uid(),date:isoShift(-25),type:'income',account:'save',amount:30000,category:'Зарплата',note:'автосплит'},
        {id:uid(),date:isoShift(-7),type:'expense',account:'fixed',amount:12000,category:'Аренда',note:''},
        {id:uid(),date:isoShift(-6),type:'expense',account:'fixed',amount:1500,category:'Связь',note:''},
        {id:uid(),date:isoShift(-5),type:'expense',account:'base',amount:2200,category:'Еда',note:'супермаркет'},
        {id:uid(),date:isoShift(-4),type:'transfer',fromAccount:'base',toAccount:'save',amount:5000,category:'Перевод',note:'на подушку'},
        {id:uid(),date:isoShift(-3),type:'expense',account:'fun',amount:3000,category:'Развлечения',note:'кино/бар'},
        {id:uid(),date:isoShift(-2),type:'debt',amount:15000,account:'base',category:'Платёж по долгу',note:'погашение'},
      ]};
    save(); renderAll(); toast('ok','Демо-данные загружены');
  };
  function isoShift(дней){const d=new Дате();d.setDate(d.getDate()+дней);return d.toISOString().slice(0,10);}

  // Экспорт/импорт/очистка
  $('#btnExport').onclick=()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`dm_fin_${new Дате().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#btnImport').onclick=()=>{$('#fileImport').click();};
  $('#fileImport').onchange=async(e)=>{
    const file=e.target.files[0]; if(!file) return;
    try{const text=await file.text(); const data=JSON.parse(text); if(!data.settings||!data.transactions) throw new Error('Неверный формат файла');
      state=data; save(); renderAll(); toast('ok','Импорт выполнен');}
    catch(err){toast('err','Ошибка импорта',err.message||String(err));}
    finally{e.target.value='';}
  };
  $('#btnWipe').onclick=()=>{
    if(confirm('Удалить все данные локально? Это действие необратимо.')){
      localStorage.removeItem(LS_KEY); state=load(); renderAll(); toast('ok','Локальная база очищена');
    }
  };

  function renderAll(){fillSettingsUI();renderDashboard();renderTable();}
  renderAll();
  setSigned(false);
})();
</script>
</body>
</html>

